{
  "enrichment": {
    "systemPrompt": "You are a call classification expert for {{client.name}}, a {{client.industry}} company. Analyze inbound calls to {{client.aiAssistantName}} and classify by outcome. Return only valid JSON.",
    "userPrompt": "Analyze this batch of {{client.name}} calls and classify each one.\n\n**BUSINESS CONTEXT:**\n{{client.description}}\n\n**Services:**\n{{servicesList}}\n\n{{client.aiAssistantName}} (AI assistant) handles inbound calls to:\n{{callPurposesList}}\n\n**CRITICAL DISTINCTION:**\n- **NEW customers** calling for a consultation/estimate = BOOKING categories\n- **EXISTING customers** calling about service/repair, warranty/registration, installation scheduling, billing, or general assistance = TRANSFERRED (use the appropriate transferReason)\n- Look for keywords: {{serviceKeywordsList}}\n\n**AVAILABLE METADATA FIELDS:**\n- **summary**: AI-generated summary (most reliable source)\n- **transcript**: Full conversation verbatim (use if summary unclear)\n- **endedReason**: Technical reason call ended:\n  * \"assistant-forwarded-call\" = Transfer completed\n  * \"customer-ended-call\" = Customer hung up\n  * \"assistant-ended-call\" = AI ended call (usually after booking or polite end)\n- **duration**: Call length in seconds\n- **transferDestinationHint**: Shows transfer destination if attempted\n- **appointmentBooked**: true if structured outputs indicate NEW consultation booking completed\n\n**CRITICAL CLASSIFICATION RULES (FOLLOW IN ORDER):**\n\n1. **RULE 1 - appointmentBooked FLAG IS DEFINITIVE**: If appointmentBooked === true -> ALWAYS classify as BOOKING-COMPLETED (this flag comes from Vapi's structured outputs and is the most reliable signal)\n2. **RULE 2 - Existing customer detection**: If summary mentions \"existing installation\", \"service\", \"warranty\", \"repair\", \"leak\", \"billing\", or \"reschedule\" -> TRANSFERRED (choose the best transferReason)\n3. **RULE 3 - Transfers**: If endedReason === \"assistant-forwarded-call\" -> TRANSFERRED or BOOKING-TRANSFERRED\n4. **RULE 4 - Abandoned bookings**: If endedReason === \"customer-ended-call\" AND booking questions asked -> BOOKING-ABANDONED\n5. **RULE 5 - Hangups**: If endedReason === \"customer-ended-call\" AND no booking questions -> HANGUP\n6. **RULE 6 - Spam**: Duration < 5 seconds -> SPAM\n\n**CLASSIFICATION CATEGORIES:**\n\n1. **booking-completed**: NEW customer successfully scheduled {{client.primaryService}}\n   - appointmentBooked === true FOR A NEW CONSULTATION (not service)\n   - Confirmation: \"appointment is confirmed\", \"see you on [DATE]\"\n   - Customer is asking about {{client.services}}\n   - **NEVER for existing customer service/warranty issues**\n\n2. **booking-abandoned**: NEW customer started booking but hung up\n   - AI asked homeowner status OR phone OR email for NEW consultation\n   - endedReason === \"customer-ended-call\"\n   - **NOT for existing customer service calls**\n\n3. **booking-transferred**: NEW customer booking attempt transferred to human\n   - AI asked booking questions for NEW consultation\n   - endedReason === \"assistant-forwarded-call\"\n   - **NOT for existing customer service calls**\n\n4. **transferred**: Call transferred without NEW booking attempt\n   - endedReason === \"assistant-forwarded-call\"\n   - ALL existing customer service/repair, warranty, installation scheduling, billing, or escalation calls go here\n   **transferReason values:**\n{{transferReasonsList}}\n\n5. **spam**: Spam, robocalls, wrong numbers\n   **spamType values:**\n   - \"short-call\": Duration < 5 seconds\n   - \"robocall-google-ads\": Keywords \"Google ads\", \"Google Business\"\n   - \"robocall-product\": Word \"Product\" before greeting\n   - \"wrong-number\": Caller didn't intend to reach {{client.name}}\n\n6. **hangup**: Customer hung up without booking attempt\n   - endedReason === \"customer-ended-call\"\n   - NO booking questions asked\n   - NOT spam (engaged for > 5s)\n   **hangupType values:**\n   - \"high-value\": 4+ turns OR 90+ seconds OR specific project details\n   - \"moderate\": 3-6 turns AND 30-90 seconds\n   - \"low-value\": <3 turns OR <30 seconds\n\n**OUTPUT FORMAT:**\nReturn JSON with this exact structure:\n```json\n{\n  \"calls\": [\n    {\n      \"callId\": \"string\",\n      \"category\": \"booking-completed|booking-abandoned|booking-transferred|transferred|spam|hangup\",\n      \"transferReason\": \"sales|estimate-scheduling|installation-scheduling|service-repair|billing|general|escalation|warranty-registration (only if category=transferred or booking-transferred)\",\n      \"spamType\": \"short-call|robocall-google-ads|robocall-product|wrong-number (only if category=spam)\",\n      \"hangupType\": \"high-value|moderate|low-value (only if category=hangup)\"\n    }\n  ]\n}\n```",
    "categories": {
      "booking-completed": "Customer successfully scheduled {{client.primaryService}}",
      "booking-abandoned": "Customer started but didn't complete booking",
      "booking-transferred": "Booking attempt transferred to human",
      "transferred": "Call forwarded to human team",
      "spam": "Spam, robocalls, or wrong numbers",
      "hangup": "Customer hung up before completion"
    }
  },
  "hangupAnalysis": {
    "systemPrompt": "You are a lead qualification expert for {{client.name}}, a {{client.industry}} company. Analyze why customers hung up during calls with {{client.aiAssistantName}} (AI assistant) and determine callback priority.",
    "userPrompt": "Analyze these hangup calls to determine which are high-value leads worthy of manual follow-up.\n\n**QUALIFICATION CRITERIA:**\n{{qualificationCriteria}}\n\n**OUTPUT FORMAT:**\nFor each call, return:\n```json\n{\n  \"callId\": \"string\",\n  \"isQualifiedLead\": boolean,\n  \"priority\": \"high|medium|low\",\n  \"hangupReason\": \"Brief reason why customer hung up\",\n  \"nextSteps\": \"Recommended action for follow-up\",\n  \"reasoning\": \"Explanation of qualification assessment\"\n}\n```",
    "qualificationCriteria": [
      "Expressed specific interest in {{client.services}}",
      "Asked about pricing, timeline, or process details",
      "Mentioned active project plans related to {{client.industry}}",
      "Requested more information or callback"
    ]
  },
  "reportGeneration": {
    "executiveSummary": "Generate an executive summary analyzing {{client.aiAssistantName}}'s performance for {{client.name}} this reporting period. Focus on booking success rate, revenue impact, customer engagement quality, and actionable insights for improving AI performance.",
    "businessContext": "{{client.name}} is a {{client.industry}} company. {{client.aiAssistantName}} handles {{client.callPurposes}}."
  }
}
