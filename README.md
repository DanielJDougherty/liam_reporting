# Vapi Reporting Framework

Multi-client reporting system for Vapi voice AI bots with GPT-powered call analysis, classification, and executive reporting.

## Overview

This framework provides comprehensive reporting for Vapi AI assistants across multiple clients. It's designed to be:

- **Reusable**: One framework, unlimited clients
- **Configurable**: JSON-based configuration, no code changes needed
- **Industry-Agnostic**: Works for any business vertical
- **Production-Ready**: ROI analysis, lead extraction, executive summaries, branded email delivery

## Structure

```
liam_reporting/
├── .github/workflows/                # GitHub Actions (scheduled reports)
│   ├── _report-engine.yml            # Reusable workflow template
│   └── lf01-reports.yml              # Leaf schedule (DOD + intraday)
├── core/                             # Reusable core libraries
│   ├── lib/                          # Generic utilities (ROI, heatmaps, classification, email)
│   ├── config-loader.js              # Load client configurations
│   └── prompt-builder.js             # Build GPT prompts from templates
├── scripts/                          # Generic report scripts
│   ├── fetch.js                      # Fetch calls from Vapi API
│   ├── enrich.js                     # Classify calls with GPT
│   ├── report-day-over-day.js        # Daily performance comparison
│   ├── report-intraday.js            # Real-time intraday reporting
│   ├── report-weekly.js              # Weekly executive summary
│   ├── scheduled-report.js           # Orchestrator (fetch -> enrich -> generate -> email)
│   ├── analyze-hangups.js            # Analyze hangup calls
│   └── download-recordings.js        # Download call recordings
├── clients/                          # Client-specific configs & data
│   └── lf01/                         # Leaf client
│       ├── config/
│       │   ├── client.json           # Business identity & context
│       │   ├── prompts.json          # GPT prompt templates
│       │   ├── report.json           # Pricing & targets
│       │   └── revenue.json          # Revenue tracking
│       ├── data/                     # Client data (auto-created)
│       │   ├── raw/                  # Raw call JSON from Vapi
│       │   ├── enriched/             # GPT-classified call data
│       │   ├── reports/              # Generated reports (MD, HTML, CSV)
│       │   ├── openai_analysis/      # Hangup analysis results
│       │   ├── recordings/           # Downloaded call recordings
│       │   ├── logs/                 # Script execution logs
│       │   └── metadata.json         # Tracking info (last fetch, etc.)
│       ├── assets/                   # Client logo for email reports
│       └── package.json              # Convenience scripts
├── package.json                      # Core dependencies
├── .env.example                      # Required environment variables
└── .gitignore
```

## Quick Start

### 1. Install Dependencies

```bash
npm install
```

### 2. Configure Environment

```bash
cp .env.example .env
# Add your API keys:
#   VAPI_API_KEY=your_vapi_key
#   OPENAI_API_KEY=your_openai_key
#   AZURE_TENANT_ID=your_azure_tenant_id
#   AZURE_CLIENT_ID=your_azure_client_id
#   AZURE_CLIENT_SECRET=your_azure_client_secret
```

### 3. Update Client Config

Edit `clients/lf01/config/client.json` with your business details:
- Company name, AI assistant name, industry
- Vapi phone numbers
- Services, keywords, call purposes
- Email recipients and branding

### 4. Run Reports

```bash
# Fetch calls from Vapi
node scripts/fetch.js --client=lf01

# Classify calls with GPT
node scripts/enrich.js --client=lf01

# Generate reports
node scripts/report-day-over-day.js --client=lf01
node scripts/report-intraday.js --client=lf01
node scripts/report-weekly.js --client=lf01

# Full pipeline: fetch -> enrich -> generate -> email
node scripts/scheduled-report.js --client=lf01 --type=dod
```

Or use convenience scripts from `clients/lf01/`:

```bash
cd clients/lf01
npm run fetch
npm run enrich
npm run report:daily
```

## Configuration

### client.json

Defines your business identity and context:

```json
{
  "name": "Your Business Name",
  "aiAssistantName": "Your AI Name",
  "industry": "your industry",
  "description": "What your business does",
  "vapi": {
    "phoneNumbers": ["your-phone-number"],
    "apiKeyEnvVar": "VAPI_API_KEY"
  },
  "services": ["Service 1", "Service 2"],
  "serviceKeywords": ["keyword1", "keyword2"],
  "callPurposes": [
    "Schedule appointments (BOOKING)",
    "Answer questions",
    "Screen spam"
  ],
  "branding": {
    "logoPath": "./assets/logo.png",
    "colors": { "headerBar": "#1a365d", "accent": "#3182ce" },
    "headerSubtitle": "Your Company | Daily Performance Report",
    "emailFooter": "Generated by SupervizeAI, LLC"
  },
  "email": {
    "from": "noni@supervizeai.com",
    "to": ["dev@yourcompany.com"],
    "toProduction": ["client@theircompany.com"],
    "subjects": {
      "dod": "{clientName} - Daily Performance Report ({date})",
      "intraday": "{clientName} - Intraday Status ({date} {time})"
    }
  }
}
```

### prompts.json

Customizes GPT prompts for your business:

- `enrichment`: Call classification prompts
- `hangupAnalysis`: Lead qualification prompts
- `reportGeneration`: Report generation prompts

Uses template variables like:
- `{{client.name}}`
- `{{client.aiAssistantName}}`
- `{{client.industry}}`
- `{{client.services}}`
- `{{serviceKeywordsList}}`

## Features

### Call Classification

6-category taxonomy:
1. **booking-completed** - Successful bookings
2. **booking-abandoned** - Started but incomplete
3. **booking-transferred** - Transferred to human
4. **transferred** - Other transfers
5. **spam** - Spam/robocalls
6. **hangup** - Customer hung up (with engagement levels)

### Reports

- **Intraday**: Real-time performance tracking
- **Day-over-Day**: Daily comparisons with historical averages
- **Weekly Executive**: Comprehensive performance summary with:
  - ROI analysis (AI vs human cost)
  - Call volume heatmaps
  - Day of week patterns
  - Week of month trends
  - High-priority lead exports (CSV)

### Branded Email Delivery

- HTML table-based layout (Outlook-safe)
- Client-specific branding (logo, colors, header, footer)
- Metadata chips (call counts, success rates, date range)
- Sent via Microsoft Graph API
- Distribution lists managed in `client.json` (`to` for dev, `toProduction` for live)

### Lead Management

Automatic extraction of high-priority leads:
- Booking abandoned (highest priority)
- High-value hangups
- New project transfers

Exports with phone numbers and emails for CRM import.

## Scripts

All scripts accept `--client=<name>` argument:

```bash
# Fetch calls
node scripts/fetch.js --client=lf01 --days=7

# Enrich calls
node scripts/enrich.js --client=lf01

# Generate reports
node scripts/report-weekly.js --client=lf01 --week=2026-W05
node scripts/report-intraday.js --client=lf01
node scripts/report-day-over-day.js --client=lf01

# Scheduled pipeline (fetch -> enrich -> generate -> email)
node scripts/scheduled-report.js --client=lf01 --type=dod
node scripts/scheduled-report.js --client=lf01 --type=intraday

# Analyze hangups
node scripts/analyze-hangups.js --client=lf01 --start=2026-01-01 --end=2026-01-31

# Download recordings
node scripts/download-recordings.js --client=lf01 --days=7
```

## Adding a New Client

1. **Copy existing client**:
   ```bash
   cp -r clients/lf01 clients/newclient
   ```

2. **Update `config/client.json`**: Business name, AI name, industry, phone numbers, services, branding, email recipients

3. **Update `config/prompts.json`**: Customize GPT prompts for your industry (or keep as-is if template placeholders work)

4. **Update `config/report.json`**: AI cost per minute, target KPIs, business hours

5. **Add a workflow**: Copy `.github/workflows/lf01-reports.yml` to `newclient-reports.yml`, change client name and cron schedule

6. **Add GitHub secrets** if the new client needs a separate Vapi API key

## Deployment (GitHub Actions)

Reports run automatically via GitHub Actions on cron schedules.

### Architecture

- `_report-engine.yml` - Reusable workflow template (checkout, install, run, upload artifact)
- `lf01-reports.yml` - Leaf's schedule: DOD at 5am ET, intraday at 11am + 3pm ET
- Manual trigger available from the Actions UI for testing

### Required Secrets

| Secret | Purpose |
|--------|---------|
| `VAPI_API_KEY` | Fetch call data from Vapi API |
| `OPENAI_API_KEY` | GPT call classification/enrichment |
| `AZURE_TENANT_ID` | Microsoft Graph email |
| `AZURE_CLIENT_ID` | Microsoft Graph email |
| `AZURE_CLIENT_SECRET` | Microsoft Graph email |

### Email Distribution

- **Dev mode**: `email.to` recipients (internal team)
- **Production**: `email.toProduction` recipients (client team) - takes priority when present
- **Emergency stop**: Remove `toProduction` entries to revert to dev-only

## Core Libraries

All libraries in `core/lib/` are industry-agnostic:

- `calculate_roi.js` - ROI calculations (AI vs human cost)
- `classify_call.js` - Rule-based call classification
- `email-sender.js` - Branded HTML email via Microsoft Graph
- `export_leads.js` - Lead extraction and CSV export
- `generate_heatmap.js` - Call volume heatmaps
- `store_enrichment.js` - Enrichment data persistence
- `store_openai_analysis.js` - Analysis result storage

## Script Pattern

All scripts follow the same pattern:
1. Accept `--client=<name>` argument
2. Load config via `require('../core/config-loader').loadClientConfig(clientName)`
3. Use `config.client.*` for all business-specific data
4. Use `config.paths.*` for file paths
5. Use `require('../core/prompt-builder')` for GPT prompts

## Troubleshooting

**"Error: --client argument is required"** - Always include `--client=<name>` when running scripts directly.

**"Client directory not found"** - Verify client folder exists: `ls clients/`

**"VAPI_API_KEY not found"** - Ensure `.env` file exists at the repo root with your API keys.

**No data directories created** - Config-loader auto-creates directories on first run. Check file permissions.

**Reports show wrong business name** - Check `clients/<name>/config/client.json` has correct values.

## License

ISC
